<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self'; img-src 'self' ha: data: blob:; media-src 'self' ha: blob:; connect-src * ha:;">
    <title>Home Assistant Widget</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Minimal header with just drag area and essential controls -->
    <div class="widget-header">
        <div class="drag-area">
            <span class="widget-title">Home Assistant</span>
            <div class="connection-indicator" id="connection-status"></div>
        </div>
        <div class="header-controls">
            <button id="settings-btn" class="control-btn" title="Settings">‚öôÔ∏è</button>
            <button id="minimize-btn" class="control-btn" title="Minimize">‚ûñ</button>
            <button id="close-btn" class="control-btn" title="Close">‚ùå</button>
        </div>
    </div>

    <!-- Main widget content - single view, no tabs -->
    <div class="widget-content">
        <!-- Quick Status Cards -->
        <div class="status-grid">
            <div class="status-card weather-card" id="weather-card" title="Long-press to configure weather">
                <div class="weather-icon" id="weather-icon">üå§Ô∏è</div>
                <div class="weather-content">
                    <div class="weather-main">
                        <div class="weather-temp" id="weather-temp">--¬∞</div>
                        <div class="weather-condition" id="weather-condition">--</div>
                    </div>
                    <div class="weather-details">
                        <div class="weather-detail">
                            <span class="detail-icon">üíß</span>
                            <span class="detail-value" id="weather-humidity">--%</span>
                        </div>
                        <div class="weather-detail">
                            <span class="detail-icon">üí®</span>
                            <span class="detail-value" id="weather-wind">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="status-card time-card" id="time-card">
                <div class="time-content">
                    <div class="time-main">
                        <div class="time-display" id="current-time">--:--</div>
                    </div>
                    <div class="date-display" id="current-date">--</div>
                </div>
            </div>
        </div>

        <!-- Media Player Tile -->
        <div class="media-tile" id="media-tile" style="display: none;">
            <div class="media-tile-artwork" id="media-tile-artwork">
                <div class="media-tile-artwork-placeholder">üéµ</div>
            </div>
            <div class="media-tile-content">
                <div class="media-tile-info">
                    <div class="media-tile-title" id="media-tile-title">No media playing</div>
                    <div class="media-tile-artist" id="media-tile-artist"></div>
                </div>
                <div class="media-tile-seek">
                    <div class="media-tile-time" id="media-tile-time-current">0:00</div>
                    <div class="media-tile-seek-bar">
                        <div class="media-tile-seek-fill" id="media-tile-seek-fill" style="width: 0%"></div>
                    </div>
                    <div class="media-tile-time" id="media-tile-time-total">0:00</div>
                </div>
                <div class="media-tile-controls">
                    <button class="media-tile-btn" id="media-tile-prev" title="Previous"></button>
                    <button class="media-tile-btn media-tile-btn-play" id="media-tile-play" title="Play/Pause"></button>
                    <button class="media-tile-btn" id="media-tile-next" title="Next"></button>
                </div>
            </div>
        </div>

        <!-- Quick Access -->
        <div class="controls-section">
            <div class="section-header">
                <span class="section-title">Quick Access</span>
                <div class="section-buttons">
                    <button id="reorganize-quick-controls-btn" class="section-btn"
                        title="Reorganize Quick Access">‚ãÆ‚ãÆ</button>
                    <button id="manage-quick-controls-btn" class="section-btn" title="Manage Quick Access">‚ûï</button>
                </div>
            </div>
            <div id="quick-controls" class="controls-grid">
                <!-- Dynamic controls will be added here -->
            </div>
        </div>

    </div>

    <!-- Settings Modal (same as before but cleaner) -->
    <div id="settings-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="settings-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="settings-title">Settings</h2>
                <button id="close-settings" class="close-btn">√ó</button>
            </div>
            <div class="modal-tabs">
                <button class="tab-link active" data-tab="general">General</button>
                <button class="tab-link" data-tab="hotkeys">Hotkeys</button>
                <button class="tab-link" data-tab="alerts">Alerts</button>
                <button class="tab-link" data-tab="advanced">Advanced</button>
            </div>
            <div class="modal-body">
                <div id="general-tab" class="tab-content active">
                    <div class="form-group">
                        <label for="ha-url">Home Assistant URL:</label>
                        <input type="text" id="ha-url" placeholder="http://homeassistant.local:8123">
                    </div>
                    <div class="form-group">
                        <label for="ha-token">Access Token:</label>
                        <input type="password" id="ha-token" placeholder="Your long-lived access token">
                    </div>

                    <div class="form-group">
                        <label for="opacity-slider">Window Opacity:</label>
                        <input type="range" id="opacity-slider" min="1" max="100" step="1" value="90">
                        <span id="opacity-value">90</span>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="always-on-top">
                            Always on top
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="start-with-windows">
                            Start with Windows
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="primary-media-player">Primary Media Player:</label>
                        <div class="custom-dropdown" id="primary-media-player-dropdown">
                            <button type="button" class="custom-dropdown-trigger" id="primary-media-player-trigger"
                                aria-haspopup="listbox" aria-expanded="false">
                                <span class="custom-dropdown-value">None (Hide Media Tile)</span>
                                <svg class="custom-dropdown-arrow" width="16" height="16" viewBox="0 0 16 16"
                                    fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </button>
                            <div class="custom-dropdown-menu" role="listbox" id="primary-media-player-menu">
                                <div class="custom-dropdown-option" role="option" data-value="">None (Hide Media Tile)
                                </div>
                            </div>
                        </div>
                        <div class="form-help">Select which media player to display in the main media tile</div>
                    </div>
                    <div class="form-group update-section">
                        <label>Application Updates</label>
                        <div class="update-info">
                            <div class="version-info">
                                <span>Current Version: <strong id="current-version">Loading...</strong></span>
                            </div>
                            <div class="update-status" id="update-status">
                                <span id="update-status-text">Checking for updates...</span>
                            </div>
                            <div class="update-actions">
                                <button id="check-updates-btn" class="btn btn-secondary" disabled>
                                    <span id="check-updates-text">Check for Updates</span>
                                </button>
                                <button id="install-update-btn" class="btn btn-primary hidden">
                                    <span id="install-update-text">Install Update</span>
                                </button>
                            </div>
                            <div class="update-progress hidden" id="update-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progress-fill"></div>
                                </div>
                                <span class="progress-text" id="progress-text">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="advanced-tab" class="tab-content">
                    <div class="form-group">
                        <label for="update-interval">Update Interval (seconds):</label>
                        <input type="number" id="update-interval" min="1" max="60" value="5">
                    </div>
                    <div class="form-group">
                        <button id="view-logs-btn" class="btn btn-secondary"
                            title="Opens the log file location in your file explorer">üìã View Logs</button>
                    </div>
                </div>
                <div id="hotkeys-tab" class="tab-content">
                    <div class="form-group">
                        <label>Popup Hotkey (Hold to Bring Window to Front)</label>
                        <p class="help-text">Configure a global hotkey that brings the window to front while held down.
                            When released, the window returns to normal z-order.</p>
                        <div class="popup-hotkey-config">
                            <input type="text" id="popup-hotkey-input" placeholder="Not set (click Set Hotkey)"
                                readonly>
                            <button id="popup-hotkey-set-btn" class="btn btn-secondary btn-small">Set Hotkey</button>
                            <button id="popup-hotkey-clear-btn" class="btn btn-danger btn-small"
                                style="display: none;">Clear</button>
                        </div>
                        <p class="help-text" style="margin-top: 8px;">
                            <strong>Recommended presets (click to use):</strong><br>
                            <button class="btn btn-secondary btn-small preset-hotkey-btn"
                                data-hotkey="Ctrl+Shift+Space">Ctrl+Shift+Space</button>
                            <button class="btn btn-secondary btn-small preset-hotkey-btn"
                                data-hotkey="Ctrl+Alt+H">Ctrl+Alt+H</button>
                            <button class="btn btn-secondary btn-small preset-hotkey-btn"
                                data-hotkey="Ctrl+Shift+F12">Ctrl+Shift+F12</button>
                        </p>
                        <div class="form-group" style="margin-top: 12px;">
                            <label id="popup-hotkey-toggle-mode-label">
                                <input type="checkbox" id="popup-hotkey-toggle-mode">
                                Press to toggle (tap to show/hide)
                            </label>
                            <p class="help-text">When enabled, press the hotkey once to show the window and again to
                                hide it. This disables hold-to-show behavior.</p>
                        </div>
                        <div class="form-group" style="margin-top: 12px;">
                            <label id="popup-hotkey-hide-on-release-label">
                                <input type="checkbox" id="popup-hotkey-hide-on-release">
                                Hide window when hotkey is released
                            </label>
                            <p class="help-text">When enabled, the window will hide when you release the popup hotkey
                                instead of just returning to normal z-order.</p>
                        </div>
                    </div>
                    <hr>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="global-hotkeys-enabled">
                            Enable Entity Hotkeys
                        </label>
                    </div>
                    <div id="hotkeys-list-container">
                        <div class="form-group">
                            <input type="text" id="hotkey-entity-search"
                                placeholder="Search entities to assign hotkeys...">
                        </div>
                        <div id="hotkeys-list"></div>
                    </div>
                    <div class="hotkey-help">
                        <p>Supported modifiers: Ctrl, Alt, Shift, Command, Super.</p>
                        <p>Example: <code>Ctrl+Shift+A</code></p>
                    </div>
                </div>
                <div id="alerts-tab" class="tab-content">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="entity-alerts-enabled">
                            Enable Entity Alerts
                        </label>
                    </div>
                    <div id="alerts-section" style="display: none;">
                        <p>Configure which entities should trigger desktop notifications.</p>
                        <div id="inline-alerts-list" class="inline-alerts-container">
                            <!-- Inline alerts list will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-settings" class="btn btn-primary">Save</button>
                <button id="cancel-settings" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Quick Access Management Modal -->
    <div id="quick-controls-modal" class="modal hidden" role="dialog" aria-modal="true"
        aria-labelledby="quick-controls-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="quick-controls-title">Manage Quick Access</h2>
                <button id="close-quick-controls" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" id="quick-controls-search" placeholder="Search entities..." class="form-control">
                </div>
                <div class="form-group">
                    <label>Available Entities for Quick Access:</label>
                    <div id="quick-controls-list" class="entity-selector-list">
                        <!-- Available entities will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
        <div class="modal-content confirm-modal-content">
            <div class="modal-header">
                <h2 id="confirm-title">Confirm Action</h2>
            </div>
            <div class="modal-body">
                <p id="confirm-message">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button id="confirm-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="confirm-ok-btn" class="btn btn-danger">Remove</button>
            </div>
        </div>
    </div>

    <!-- Weather Configuration Modal -->
    <div id="weather-config-modal" class="modal hidden" role="dialog" aria-modal="true"
        aria-labelledby="weather-config-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="weather-config-title">Configure Weather</h2>
                <button id="close-weather-config" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Weather Entity:</label>
                    <div id="weather-entities-list" class="entity-selector-list">
                        <!-- Available weather entities will be loaded here -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Current Weather Entity:</label>
                    <div id="current-weather-info" class="weather-info">
                        <span id="current-weather-name">None selected</span>
                        <button id="clear-weather" class="btn btn-secondary btn-sm">Clear</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Hotkeys Management Modal -->
    <div id="hotkeys-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="hotkeys-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="hotkeys-title">Manage Global Hotkeys</h2>
                <button id="close-hotkeys" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" id="hotkey-search" placeholder="Search entities..." class="form-control">
                </div>
                <div class="form-group">
                    <label>Configure Hotkeys:</label>
                    <div id="hotkeys-list" class="hotkeys-list">
                        <!-- Hotkey configurations will be loaded here -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Existing Hotkeys:</label>
                    <div id="existing-hotkeys-list" class="existing-hotkeys-list">
                        <!-- Existing hotkey configurations will be loaded here -->
                    </div>
                </div>
                <div class="hotkey-help">
                    <h4>Hotkey Format:</h4>
                    <p>Use combinations like: <code>Ctrl+Alt+L</code>, <code>Ctrl+Shift+1</code>, <code>Alt+F1</code>
                    </p>
                    <p>Available modifiers: <code>Ctrl</code>, <code>Alt</code>, <code>Shift</code>, <code>Win</code>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Entity Alerts Management Modal -->
    <div id="alerts-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="alerts-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="alerts-title">Manage Entity Alerts</h2>
                <button id="close-alerts" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" id="alert-search" placeholder="Search entities..." class="form-control">
                </div>
                <div class="form-group">
                    <label>Configure Alerts:</label>
                    <div id="alerts-list" class="alerts-list">
                        <!-- Alert configurations will be loaded here -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Existing Alerts:</label>
                    <div id="existing-alerts-list" class="existing-alerts-list">
                        <!-- Existing alert configurations will be loaded here -->
                    </div>
                </div>
                <div class="alert-help">
                    <h4>Alert Types:</h4>
                    <p><strong>State Change:</strong> Notify when entity state changes</p>
                    <p><strong>Specific State:</strong> Notify when entity reaches a specific state</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Hotkey Configuration Modal -->
    <div id="hotkey-config-modal" class="modal hidden" role="dialog" aria-modal="true"
        aria-labelledby="hotkey-config-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="hotkey-config-title">Configure Hotkey</h2>
                <button id="close-hotkey-config" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="hotkey-input">Hotkey Combination:</label>
                    <button id="hotkey-input" class="form-control hotkey-capture-btn">Click to set hotkey</button>
                    <div class="form-help">Click the button and press your desired key combination. Press
                        <code>ESC</code> to clear.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-hotkey" class="btn btn-primary">Save</button>
                <button id="cancel-hotkey" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Camera Viewer Modal (created dynamically by openCamera) -->

    <!-- Alert Configuration Modal -->
    <div id="alert-config-modal" class="modal hidden" role="dialog" aria-modal="true"
        aria-labelledby="alert-config-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="alert-config-title">Configure Alert</h2>
                <button id="close-alert-config" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Alert Type:</label>
                    <div class="alert-type-options">
                        <label class="radio-option">
                            <input type="radio" name="alert-type" value="state-change" checked>
                            <span class="radio-label">
                                <strong>State Change</strong>
                                <small>Notify when entity state changes</small>
                            </span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="alert-type" value="specific-state">
                            <span class="radio-label">
                                <strong>Specific State</strong>
                                <small>Notify when entity reaches a specific state</small>
                            </span>
                        </label>
                    </div>
                </div>
                <div class="form-group" id="specific-state-group" style="display: none;">
                    <label for="target-state-input">Target State:</label>
                    <input type="text" id="target-state-input" placeholder="e.g., on, off, open, closed"
                        class="form-control">
                    <div class="form-help">Enter the state you want to be notified about</div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-alert" class="btn btn-primary">Save</button>
                <button id="cancel-alert" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Alert Entity Picker Modal -->
    <div id="alert-entity-picker-modal" class="modal hidden" role="dialog" aria-modal="true"
        aria-labelledby="alert-entity-picker-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="alert-entity-picker-title">Add Alert</h2>
                <button id="close-alert-entity-picker" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" id="alert-entity-picker-search" placeholder="Search entities..."
                        class="form-control">
                </div>
                <div class="form-group">
                    <label>Select Entity to Configure Alert:</label>
                    <div id="alert-entity-picker-list" class="entity-selector-list">
                        <!-- Available entities will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Connecting to Home Assistant...</p>
    </div>

    <!-- Toast notifications -->
    <div id="toast-container" class="toast-container"></div>

    <script src="renderer.js"></script>
</body>

</html>